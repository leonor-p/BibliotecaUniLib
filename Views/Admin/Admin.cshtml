@model IEnumerable<Microsoft.AspNetCore.Identity.IdentityUser>
@using Microsoft.AspNetCore.Identity
@using System.Collections.Generic

<h2 class="text-center mb-4">Gerir Contas</h2>

<div class="d-flex justify-content-between mb-3">
    <a asp-controller="Admin" asp-action="CreateUser" class="btn btn-success">Criar Novo Utilizador</a>
</div>

<div class="card mb-5">
    <div class="card-header bg-primary text-white">
        <h4 class="m-0">Contas Ativas</h4>
    </div>
    <div class="card-body">
        @foreach (var role in ViewData["ActiveRoles"] as Dictionary<string, List<IdentityUser>>)
        {
            <h5 class="mt-4">
                @if (role.Key == "Librarian")
                {
                    @:Bibliotecário
                }
                else if (role.Key == "Admin")
                {
                    @:Administrador
                }
                else if (role.Key == "Reader")
                {
                    @:Leitor
                }
            </h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th class="text-end"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in role.Value)
                    {
                        var userManager = ViewData["UserManager"] as UserManager<IdentityUser>;
                        var userBlocks = ViewData["UserBlocks"] as Dictionary<string, bool>;
                        var isBlocked = userBlocks.ContainsKey(user.UserName) && userBlocks[user.UserName];
                        var isActive = ViewData["ActiveAccounts"] is HashSet<string> activeAccounts && activeAccounts.Contains(user.Id);

                        if (isActive)
                        {
                            var userRoles = userManager?.GetRolesAsync(user).Result ?? new List<string>();
                            var isAdmin = userRoles.Contains("Admin");

                            <tr>
                                <td>@user.Id</td>
                                <td>@user.UserName</td>
                                <td>@user.Email</td>
                                <td class="text-end">
                                    @if (!isAdmin)
                                    {
                                        <a asp-action="EditUser" asp-route-id="@user.Id" class="btn btn-primary btn-sm mr-2">Editar</a>

                                        <form asp-action="ToggleAccountBlock" asp-route-id="@user.Id" method="post" style="display:inline;" onsubmit="return confirm('Tem a certeza que deseja alternar o estado de bloqueio?');">
                                            <button type="submit" class="btn btn-@(isBlocked ? "success" : "warning") btn-sm mr-2">
                                                @(isBlocked ? "Desbloquear" : "Bloquear")
                                            </button>
                                        </form>

                                        <form asp-action="DeleteUser" asp-route-id="@user.Id" method="post" style="display:inline;" onsubmit="return confirm('Tem a certeza que deseja eliminar este utilizador?');">
                                            <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                                        </form>
                                    }
                                    else
                                    {
                                        <button class="btn btn-primary btn-sm mr-2" disabled>Editar</button>

                                        <button class="btn btn-@(isBlocked ? "success" : "warning") btn-sm mr-2" disabled>
                                            @(isBlocked ? "Desbloquear" : "Bloquear")
                                        </button>

                                        <button class="btn btn-danger btn-sm" disabled>Eliminar</button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<div class="card">
    <div class="card-header bg-secondary text-white">
        <h4 class="m-0">Contas Inativas</h4>
    </div>
    <div class="card-body">
        @foreach (var role in ViewData["InactiveRoles"] as Dictionary<string, List<IdentityUser>>)
        {
            <h5 class="mt-4">
                @if (role.Key == "Librarian")
                {
                    @:Bibliotecário
                }
                else if (role.Key == "Admin")
                {
                    @:Administrador
                }
                else if (role.Key == "Reader")
                {
                    @:Leitor
                }
            </h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th class="text-end"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in role.Value)
                    {
                        <tr>
                            <td>@user.Id</td>
                            <td>@user.UserName</td>
                            <td>@user.Email</td>
                            <td class="text-end">
                                <form asp-action="ActivateAccount" asp-route-id="@user.Id" method="post" style="display:inline;" onsubmit="return confirm('Tem a certeza que deseja ativar esta conta?');">
                                    <button type="submit" class="btn btn-success btn-sm">Ativar</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<footer>
    <div class="grid footer">
        <div class="card_logo">
            <img src="/imagens/logo200.png" alt="logo UniLib">
        </div>
        <div class="grid sb">
            <h3>Sobre nós</h3>
            <p></p>
            <a href="@Url.Action("Privacy", "Home")">Política de Privacidade</a>
            <p></p>
            <a href="@Url.Action("Termos", "Home")">Termos de Serviço</a>
            <p></p>
        </div>
        <div class="grid ajuda">
            <h3>Ajuda</h3>
            <p></p>
            <a href="@Url.Action("Ajuda", "Home")">Caixa de Mensagens</a>
        </div>
    </div>
</footer>

<style>
    
    .bg-primary {
        --bs-bg-opacity: 1;
        background-color: rgba(var(--bs-secondary-rgb), var(--bs-bg-opacity)) !important;
    }

    h2 {
        font-size: 2rem;
        color: #5e0606;
    }

    h4 {
        font-size: 1.5rem;
        color: white;
    }
    .btn-success,
    .btn-primary,
    .btn-warning,
    .btn-danger {
        color: #fff;
        background-color: #5e0606;
        border-color: #5e0606;
    }

        .btn-success:hover,
        .btn-primary:hover,
        .btn-warning:hover,
        .btn-danger:hover {
            background-color: #470404;
            border-color: #470404;
        }

    .bg-primary {
        --bs-bg-opacity: 1;
        background-color: #5e0606;
    }

    h5 {
        font-size: 1.25rem;
        color: #5e0606;
    }

    .bg-secondary {
        --bs-bg-opacity: 1;
        background-color: rgba(var(--bs-secondary-rgb), var(--bs-bg-opacity)) !important;
    }
</style>
